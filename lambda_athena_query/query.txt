SELECT
'' AS "Ticket #",
'' AS "Assigned To",
'' AS "Notes",
awsregion,
'=MID(H2,SEARCH("username=",H2)+9,SEARCH(", sessioncontext=",H2)-SEARCH("username=",H2)-9)' AS "User",
'=IF(J2="RunInstances",left(Right(K2,Len(K2)-SEARCH("key",K2)-20), len(Right(K2,Len(K2)-SEARCH("key",K2)-27) )),"")' AS "Deployment",

    CASE
    WHEN eventname = 'RequestCertificate'
        OR eventname ='DeleteCertificate' THEN
    'ACM Cert Listing'
    WHEN eventname = 'CreateBucket'
        OR eventname = 'PutBucketPolicy'
        OR eventname = 'DeleteBucket' THEN
    'S3'
    WHEN eventname = 'TerminateInstances'
        OR eventname = 'StopInstances'
        OR eventname = 'RunInstances'
        OR eventname = 'CreateImage'
        OR eventname = 'RebootInstances'
        OR eventname = 'DeregisterTargets'
        OR eventname = 'DeregisterImage'
        OR eventname = 'RegisterTargets'
        OR eventname = 'ModifyInstanceAttribute' THEN
    'EC2 Instances'
    WHEN eventname ='RunInstances'
        OR eventname = 'CreateLoadBalancer'
        OR eventname = 'CreateTargetGroup'
        OR eventname = 'RebootInstances'
        OR eventname = 'DeregisterTargets'
        OR eventname = 'RegisterTargets'
        OR eventname = 'ModifyInstanceAttribute' THEN
    'EC2 VPC'
    WHEN eventname = 'CreateListener'
        OR eventname = 'DeleteListener'
        OR eventname = 'ModifyListener' THEN
    'ELB'
    WHEN eventname = 'DeleteDBCluster'
        OR eventname = 'DeleteDBInstance'
        OR eventname = 'ModifyDBInstance'
        OR eventname = 'ModifyDBCluster'
        OR eventname = 'FailoverDBCluster'
        OR eventname = 'CreateDBInstance' THEN
    'RDS'
    WHEN eventname = 'CreateHostedZone'
        OR eventname ='ChangeResourceRecordSets'
        OR eventname = 'CreateVpcEndpoint'
        OR eventname ='CreateVpc'
        OR eventname ='CreateVpcLink'
        OR eventname ='ModifyVpcEndpoint'
        OR eventname ='AssociateVpcCidrBlock'
        OR eventname ='CreateDBSecurityGroup'
        OR eventname ='CreateSecurityGroup'
        OR eventname ='AuthorizeDBSecurityGroupIngress'
        OR eventname ='CreateUser'
        OR eventname ='DeleteUser'
        OR eventname ='CreatePolicy'
        OR eventname ='AttachGroupPolicy'
        OR eventname ='AttachPolicy'
        OR eventname ='AttachRolePolicy'
        OR eventname ='UpdatePolicy'
        OR eventname ='AuthorizeSecurityGroupIngress' THEN
    'Major Infra Change'
    ELSE 'Other'
    END AS Category , useridentity, eventtime, eventname, requestparameters, responseelements, sourceipaddress, useragent,  errorcode, eventsource,errormessage, additionaleventdata, requestid, eventid, resources, eventtype, apiversion, readonly, recipientaccountid, serviceeventdetails, sharedeventid, vpcendpointid, eventversion
FROM cloudtrail_logs_sendsafely_elb_logging_ssglobaltrail
WHERE (eventname = 'RequestCertificate'
        OR eventname = 'DeleteCertificate'
        OR eventname = 'CreateBucket'
        OR eventname = 'PutBucketPolicy'
        OR eventname = 'DeleteBucket'
        OR eventname = 'TerminateInstances'
        OR eventname = 'StopInstances'
        OR eventname = 'RunInstances'
        OR eventname = 'CreateImage'
        OR eventname = 'RebootInstances'
        OR eventname = 'DeregisterTargets'
        OR eventname = 'DeregisterImage'
        OR eventname = 'RegisterTargets'
        OR eventname = 'ModifyInstanceAttribute'
        OR eventname = 'RunInstances'
        OR eventname = 'CreateLoadBalancer'
        OR eventname = 'CreateTargetGroup'
        OR eventname = 'RebootInstances'
        OR eventname = 'DeregisterTargets'
        OR eventname = 'RegisterTargets'
        OR eventname = 'ModifyInstanceAttribute'
        OR eventname = 'CreateListener'
        OR eventname = 'DeleteListener'
        OR eventname = 'ModifyListener'
        OR eventname = 'DeleteDBCluster'
        OR eventname = 'DeleteDBInstance'
        OR eventname = 'ModifyDBInstance'
        OR eventname = 'ModifyDBCluster'
        OR eventname = 'FailoverDBCluster'
        OR eventname = 'CreateDBInstance'
        OR eventname = 'CreateHostedZone'
        OR eventname = 'ChangeResourceRecordSets'
        OR eventname = 'CreateVpcEndpoint'
        OR eventname = 'CreateVpc'
        OR eventname = 'CreateVpcLink'
        OR eventname = 'ModifyVpcEndpoint'
        OR eventname = 'AssociateVpcCidrBlock'
        OR eventname = 'CreateDBSecurityGroup'
        OR eventname = 'CreateSecurityGroup'
        OR eventname = 'AuthorizeDBSecurityGroupIngress'
        OR eventname = 'CreateUser'
        OR eventname = 'CreatePolicy'
        OR eventname = 'AttachGroupPolicy'
        OR eventname = 'AttachPolicy'
        OR eventname = 'AttachRolePolicy'
        OR eventname = 'UpdatePolicy'
        OR eventname = 'AuthorizeSecurityGroupIngress' )
        AND eventtime > '2021-05-01T00:00:00Z'
        AND eventtime < '2021-06-01T00:00:00Z'
        AND useragent != 'kubernetes/v1.15.6 aws-sdk-go/1.16.26 (go1.12.12; linux; amd64)'
ORDER BY eventtime
